pipeline {
  agent any
  environment {
    GIT_COMMIT = ""
    DOCKERHUB_USERNAME = sh(script: 'source .env && echo ${DOCKERHUB_USERNAME}', returnStdout: true).trim()
    DOCKERHUB_PASSWORD = sh(script: 'source .env && echo ${DOCKERHUB_PASSWORD}', returnStdout: true).trim()
  }
  stages {
    stage('Get Git commit hash') {
      steps {
        script {
          GIT_COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
        }
      }
    }
    stage('Docker Login') {
      steps {
        sh 'echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin'
      }
    }
    stage('Build Docker images') {
      steps {
        sh 'docker build -t $DOCKERHUB_USERNAME/cicd-pipeline-image:${GIT_COMMIT} .'
        sh 'docker build -t $DOCKERHUB_USERNAME/cicd-pipeline-image:latest .'
      }
    }
    stage('Push Docker images to DockerHub') {
      steps {
        sh 'docker push $DOCKERHUB_USERNAME/cicd-pipeline-image:${GIT_COMMIT}'
        sh 'docker push $DOCKERHUB_USERNAME/cicd-pipeline-image:latest'
      }
    }
  }
}
